Bootstrap: docker
From: ubuntu:latest

%labels
    echo -e "\n==================== Label Section ===================="
    MAINTENER "Yusuke Watanabe (ywatanabe@alumni.u-tokyo.ac.jp)"
    VERSION "v1.0.0"
    BUILT_DATE `date`
    DEFINITION_FILE_NAME `basename "$0"`

%setup -c /bin/bash
    echo -e "\n==================== Setup Section ===================="

    # Workspace
    mkdir -p ${SINGULARITY_ROOTFS}/workspace

    # Envs
    source $NINJA_ROOT/config/env/00_all.env
    
    # Rsync options
    export RSYNC_OPTIONS="-av \
        --safe-links \
        --exclude=**/.git \
        --exclude=**/*.sandbox \
        --exclude=**/*.sif \
        --exclude=**/__pycache__ \
        --exclude=**/*docker* \
        --exclude=**/.* \
        --exclude=**/*cache* \
        --exclude='**/build-temp*' \
        --exclude='**/*secret*'
    "

    # Rsync Environmental Variables
    mkdir -p ${SINGULARITY_ROOTFS}/opt/Ninja/config/env/
    rsync $RSYNC_OPTIONS $NINJA_ROOT/config/env/ ${SINGULARITY_ROOTFS}/opt/Ninja/config/env/

    # Rsync Building Files
    mkdir -p ${SINGULARITY_ROOTFS}/opt/Ninja/apptainer/build/
    rsync $RSYNC_OPTIONS $NINJA_ROOT/apptainer/build/ ${SINGULARITY_ROOTFS}/opt/Ninja/apptainer/build/

%post -c /bin/bash
    echo -e "\n==================== Post Section ===================="

    # Environmental Variables
    source /opt/Ninja/config/env/00_all.env

    # Add environment sourcing to both bashrc and profile
    echo '# Source Ninja environment' >> /etc/bash.bashrc
    echo 'source /opt/Ninja/config/env/00_all.env' >> /etc/bash.bashrc
    echo '# Source Ninja environment' >> /etc/profile
    echo 'source /opt/Ninja/config/env/00_all.env' >> /etc/profile

    # System
    /opt/Ninja/apptainer/build/system-setup/00_apt_packages.sh
    /opt/Ninja/apptainer/build/system-setup/01_emacs.sh
    /opt/Ninja/apptainer/build/system-setup/02_python.sh

    # # Ninja Users
    # /opt/Ninja/apptainer/build/user-setup/environment/01_ninja_users.sh
    # /opt/Ninja/apptainer/build/user-setup/environment/02_bashrc.sh
    # /opt/Ninja/apptainer/build/user-setup/environment/03_python_env.sh
    # /opt/Ninja/apptainer/build/user-setup/emacs/01_emacsd.sh
    # /opt/Ninja/apptainer/build/user-setup/permissions/00_all.sh

    # env | grep ^NINJA_
    # env | grep ^APPTAINERENV_NINJA_